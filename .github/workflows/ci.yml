name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Check formatting
        run: npx prettier --check "src/**/*.{ts,tsx,json}"
      
      - name: TypeScript compilation
        run: npx tsc --noEmit

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm run test:unit
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build extension
        run: npm run build
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: extension-build
          path: build/
      
      - name: Upload zip artifact
        uses: actions/upload-artifact@v3
        with:
          name: extension-zip
          path: local-ai-assistant-extension.zip

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install chromium
      
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: extension-build
          path: build/
      
      - name: Run integration tests
        run: npm run test:integration
      
      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: playwright-report/

  test-perf:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: extension-build
          path: build/
      
      - name: Run performance tests
        run: npm run test:perf
      
      - name: Check performance gates
        run: |
          node -e "
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('perf-report.json'));
          const medianLatency = report.medianLatency;
          if (medianLatency > 300) {
            throw new Error('Performance gate failed: median latency ' + medianLatency + 'ms > 300ms');
          }
          console.log('Performance gate passed: median latency ' + medianLatency + 'ms');
          "
      
      - name: Upload performance report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: perf-report
          path: perf-report.json

  network-isolation:
    name: Network Isolation Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: extension-build
          path: build/
      
      - name: Check for network calls in built code
        run: |
          echo "Checking for prohibited network APIs in built code..."
          
          # Check for fetch
          if grep -r "fetch(" build/ --include="*.js" | grep -v "// @allowed"; then
            echo "ERROR: Found fetch() calls in built code"
            exit 1
          fi
          
          # Check for XMLHttpRequest
          if grep -r "XMLHttpRequest" build/ --include="*.js" | grep -v "// @allowed"; then
            echo "ERROR: Found XMLHttpRequest in built code"
            exit 1
          fi
          
          # Check for sendBeacon
          if grep -r "sendBeacon" build/ --include="*.js" | grep -v "// @allowed"; then
            echo "ERROR: Found sendBeacon in built code"
            exit 1
          fi
          
          # Check for WebSocket
          if grep -r "WebSocket" build/ --include="*.js" | grep -v "// @allowed"; then
            echo "ERROR: Found WebSocket in built code"
            exit 1
          fi
          
          echo "✓ No prohibited network APIs found"
      
      - name: Check bundle size
        run: |
          BUNDLE_SIZE=$(du -sb build/ | cut -f1)
          MAX_SIZE=$((5 * 1024 * 1024))  # 5MB
          
          if [ $BUNDLE_SIZE -gt $MAX_SIZE ]; then
            echo "ERROR: Bundle size $BUNDLE_SIZE exceeds maximum $MAX_SIZE"
            exit 1
          fi
          
          echo "✓ Bundle size OK: $BUNDLE_SIZE bytes"

  worker-enforcement:
    name: Worker Enforcement Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run worker enforcement tests
        run: npm run test:unit -- --grep "worker.*enforcement"
